# 20377199 赵芮箐 第15周作业

![image-20221212223231702](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221212223231702.png)

### 总体思路

- 又又又很摸鱼的一周哈哈哈，这周真的要求 is 真的很少

- 主要是在14周的基础上把信息写入文件改成了写入数据库

- 实现了简单的查询功能

### 数据库连接：

```python
if __name__=='__main__':
    async_time_start = time.time()
    
    p_jobs = []
    p = pool.Pool(20)
    for i in range(0, 1300, 35):
        url = 'https://music.163.com/discover/playlist/?cat=流行&order=hot&limit=35&offset=' + str(i)
        p_jobs.append(p.spawn(producer, url))
    gevent.joinall(p_jobs)

    # 话说我把游标当参数传给consumer, 就不需要异步连接了啊
    with psycopg2.connect(dsn) as conn:
        with conn.cursor() as cur:
            c_jobs=[p.spawn(consumer, id, cur) for id in id_list]
            gevent.joinall(c_jobs)
    conn.commit()

    print("总耗时：%.4f" %(time.time()-async_time_start))
```

### 爬虫部分：

```python
id_list = []
dsn = "dbname=zrq user=postgres password=20020909ZRQ"
headers = {  
        'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36'  
    }

def producer(url):
    response = requests.get(url=url, headers=headers)  
    html = response.text 
    soup = BeautifulSoup(html, 'html.parser')   
    ids = soup.select('.dec a')					# 获取包含歌单详情页网址的标签
    id_list.extend(ids)

def consumer(id, cur):
    url = 'https://music.163.com/' + id['href']	# 获取歌单详情页地址
    response = requests.get(url=url, headers=headers)
    html = response.text
    soup = BeautifulSoup(html, 'html.parser')
    # 获取ID
    ID = id['href'].split('=')[-1]
    # 获取歌单标题
    title = soup.find('h2', "f-ff2 f-brk").text
    # 获取歌单介绍
    try:
        text = soup.find('p', id="album-desc-more").text.replace('\n', '')
    except: 
        text = '无'
    # 获取创建者昵称
    author = soup.find('a', "s-fc7").text
    # 获取创建日期
    date = soup.find('span', 'time s-fc4').text[:10]
    #print(ID,title,text,author,date)

    # 将详情页信息写入数据库中
    cur.execute("INSERT INTO music VALUES (%s, %s, %s, %s, %s)", (ID,title,text,author,date))
```

PS：其实相较于上周就改了最后一句话...

PPS：我着实没懂 mp3_path 和 related_articles 是啥

### 数据查询：

```python
import datetime
import psycopg2
import psycopg2.extras

dsn = "dbname=zrq user=postgres password=20020909ZRQ"

def select(keyword, mode, sheet='music'):
    if mode == 'title':
        command = f"select * from {sheet} where {mode} like '%{keyword}%'"
    else:
        command = f"Select * from {sheet} where {mode} = '{keyword}'"
    with psycopg2.connect(dsn) as conn:
        with conn.cursor(cursor_factory=psycopg2.extras.DictCursor) as dict_cur:
            dict_cur.execute(command)
            res = dict_cur.fetchall()
            music = [r['title'] for r in res]
    return music

print('-----按ID-----')
for music in select('4891546330', '"ID"'): print(music)
print('-----按title-----')
for music in select('夏天', 'title'): print(music)
print('-----按author-----')
for music in select('网易云音乐', 'author'): print(music)
print('-----按date-----')
for music in select(datetime.date(2020,5,20), 'date'): print(music)
```

PS：通用网站搜索结果貌似就是歌单名，所以这里只show歌单名

### 结果展示

- 运行时间：

  ![image-20221214215558076](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221214215558076.png)

  > 跟上一次写入文件耗时差不多

- 数据库文件

  ![image-20221214221243313](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221214221243313.png)

- 数据查询

  <img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221214234626488.png" alt="image-20221214234626488" style="zoom:67%;" />

### 代码：

https://github.com/rachhhhing/mp2022_python/blob/master/week15

### Ref：

- pyscopg2：https://www.psycopg.org/docs/
- sql语法：https://www.runoob.com/sql/sql-syntax.html



程设课程完结撒花 *★,°*:.☆(￣▽￣)/$:*.°★* 。

感谢辛苦授课的赵老师 and 辛苦批改作业和答疑解惑的两位助教姐姐(づ￣ 3￣)づ
