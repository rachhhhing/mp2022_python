# 20377199 èµµèŠ®ç® ç¬¬13å‘¨ä½œä¸š

![image-20221129001940437](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221129001940437.png)

### é¢˜ç›®äºŒæ€è·¯ï¼š

- æœåŠ¡ç«¯çš„ä¸»çº¿ç¨‹ç”¨tcpä¸€ç›´ç›‘å¬ï¼Œå®¢æˆ·ç«¯è¿›è¡Œæ¥å…¥
- è·å–å®¢æˆ·ç«¯çš„ipå’Œç«¯å£åï¼Œå¼€å¯å­çº¿ç¨‹ç”¨udpä¼ è¾“ç›‘æ§è§†é¢‘æ•°æ®
- å®¢æˆ·ç«¯é€€å‡ºæ—¶ä¼šé€šè¿‡udpåé¦ˆä¿¡æ¯ï¼Œå­çº¿ç¨‹éšå³ç»“æŸ

> maybe tcp&udpä¸€èµ·ç”¨çš„å†™æ³•æœ‰ç‚¹ç¬¨è›‹ï¼Œä½†æ˜¯æ˜¯æ”¹äº†å¤šæ¬¡åå¦¥åçš„ç»“æœã€‚
>
> åªç”¨udpå®ç°å…¨éƒ¨çš„è¯ï¼Œå®¢æˆ·ç«¯é€€å‡ºåä¸»çº¿ç¨‹çš„ç½‘ç»œä¹Ÿä¼šæ–­æ‰ï¼Œå…¶ä»–çš„å®¢æˆ·ç«¯å°±æ²¡åŠæ³•æ¥å…¥äº†ã€‚
>
> æ‰€ä»¥æœ€åé€‰æ‹©ç”¨tcpå®ç°æ¥å…¥ç¡®è®¤çš„è¿™éƒ¨åˆ†ï¼Œä¸å¾—ä¸è¯´tcpä¸‰æ¬¡æ¡æ‰‹iså¯é è®¸å¤šã€‚
>
> anyway, è‡³å°‘æ˜¯tcpå’Œudpéƒ½ç»ƒä¹ åˆ°äº†å°±æ˜¯è¯´ã€‚

### Part1: æœåŠ¡ç«¯

```python
import cv2
import sys
import numpy as np
from socket import *
from threading import Thread
from datetime import datetime

class Server():
    def __init__(self, socket, addr, capture):
        self._socket = socket
        self._addr = addr
        self._cap = capture
    
    def __get_cam(self):
        while True:
            ret, frame = self._cap.read()
            yield frame

    def post_cam(self):
        for frame in self.__get_cam():
            img_encode = cv2.imencode('.jpg', frame)[1]
            data_encode = np.array(img_encode)
            data = data_encode.tobytes()
            self._socket.sendto(data, self._addr)
            reply, addr = self._socket.recvfrom(1024)
            # æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯è‹¥ä¸ºé€€å‡º, åˆ™ç»“æŸçº¿ç¨‹
            if reply.decode('utf-8') == 'end':
                break
        with open('week13/ServerLog.txt', 'a', encoding='utf-8') as f:
            f.write(f'{datetime.now()} å®¢æˆ·ç«¯{self._addr} é€€å‡º\n')

def accpet_client():
    # tcpé€šè®¯ç”¨äºè·å–æ¥å…¥çš„ip
    tcp_socket = socket(AF_INET, SOCK_STREAM)
    tcp_socket.bind(('0.0.0.0', 9999))
    tcp_socket.listen(5)
    # udpé€šè®¯ç”¨äºä¼ è¾“è§†é¢‘
    udp_socket = socket(AF_INET, SOCK_DGRAM)
    capture = cv2.VideoCapture(0)
    capture.set(3, 160) # æ•…æ„ä¿®æ”¹å°çš„ï¼Œä¸ç„¶macä¸Šå®¹æ˜“è¶…è¿‡udpå‘é€æ•°æ®çš„é•¿åº¦é™åˆ¶
    capture.set(4, 90)  # windowsä¸Šå¥½åƒä¸ç”¨è¿™ä¹ˆå°
    while True:
        print('æ–°çš„å®¢æˆ·ç«¯æ­£åœ¨æ¥å…¥ä¸­...')
        conn, addr = tcp_socket.accept()
        client = (addr[0], int(conn.recv(1024).decode('utf-8')))
        # è®°å½•Logæ—¥å¿—
        with open('week13/ServerLog.txt', 'a', encoding='utf-8') as f:
            f.write(f'{datetime.now()} å®¢æˆ·ç«¯{client} æ¥å…¥\n')
        # å¼€å¯å­çº¿ç¨‹, ä¼ è¾“ç›‘æ§è§†é¢‘
        s = Server(udp_socket, client, capture)
        t = Thread(target=Server.post_cam, args=(s,))
        t.start()

if __name__ == "__main__":
    a = Thread(target=accpet_client)
    a.start()
    a.join()
```

### Part2: å®¢æˆ·ç«¯

```python
import cv2
import sys
import time
import numpy as np
from socket import *
from datetime import datetime

rsize = 400000
fourcc = cv2.VideoWriter_fourcc(*'XVID')

class Receiver:
    def __init__(self, socket, addr, savetime=15, savepath='D:/code/mp2022/week13/camera'):
        self._socket = socket
        self._addr = addr
        self._time = savetime
        self._path = savepath
    
    def __save_cam(self, frame):
        # æ¯ä¸€æ®µæ—¶é—´å‚¨å­˜ä¸€æ¬¡è§†é¢‘
        if time.time() - self._start > self._time:
            self._start = time.time()
            path = self._path + (datetime.now().strftime('%H-%M-%S')) + '.avi'
            self._out = cv2.VideoWriter(path, fourcc, 10.0, (160,120))
        self._out.write(frame)

    def receive_cam(self):
        self._socket.bind(self._addr)
        self._start = time.time()
        path = self._path + (datetime.now().strftime('%H-%M-%S')) + '.avi'
        self._out = cv2.VideoWriter(path, fourcc, 10.0, (160,120))
        # fourcc æŒ‡å®šç¼–ç å™¨; fps è¦ä¿å­˜çš„è§†é¢‘çš„å¸§ç‡
        while True:
            data, addr = self._socket.recvfrom(rsize)
            nparr = np.frombuffer(data, np.uint8)
            img_decode = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
            cv2.imshow('receive', img_decode)
            self.__save_cam(img_decode)		# å‚¨å­˜æ¯ä¸€å¸§
            c = cv2.waitKey(50)
            udp_socket.sendto('continue'.encode('utf-8'), addr)
            if c == 27:         			# æŒ‰äº†escåå¯ä»¥é€€å‡º
                cv2.destroyAllWindows()
                udp_socket.sendto('end'.encode('utf-8'), addr)
                break

if __name__ == "__main__":
    # å’ŒæœåŠ¡å™¨è¿æ¥, å°†è‡ªå·±ipå’Œportå‘è¿‡å»
    # sys.argv[1], sys.argv[2] æ˜¯æœåŠ¡å™¨çš„ipå’Œport
    # sys.argv[3] æ˜¯å®¢æˆ·ç«¯ç”¨äºæ¥æ”¶è§†é¢‘çš„ç«¯å£å·
    tcp_socket = socket(AF_INET, SOCK_STREAM)
    tcp_socket.connect((sys.argv[1], int(sys.argv[2])))
    tcp_socket.send((sys.argv[3]).encode('utf-8'))
    udp_socket = socket(AF_INET, SOCK_DGRAM)
    r = Receiver(udp_socket, ('0.0.0.0', int(sys.argv[3])))
    r.receive_cam()
```

### æµ‹è¯•ç»“æœï¼š

- å¤šå°å®¢æˆ·ç«¯é“¾æ¥è·å–è§†é¢‘ï¼š

  <img src="C:\Users\DELL\AppData\Local\Temp\WeChat Files\927b42d0108753d43dde969d46d76ab.jpg" alt="927b42d0108753d43dde969d46d76ab" style="zoom:33%;" />

  <img src="C:\Users\DELL\AppData\Local\Temp\WeChat Files\2d3a956e4b071ed7b39165debec9011.jpg" alt="2d3a956e4b071ed7b39165debec9011" style="zoom:34%;" />

  <img src="C:\Users\DELL\AppData\Local\Temp\WeChat Files\a2514e14f145d83fdce90cce939e04f.jpg" alt="a2514e14f145d83fdce90cce939e04f" style="zoom:31.5%;" />

- ä¿å­˜çš„è§†é¢‘ï¼š

  <img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221205000849390.png" alt="image-20221205000849390" style="zoom:50%;" />

  > å¯çˆ±è€Œåˆæ¨¡ç³Šçš„æˆ‘

- Logæ—¥å¿—ï¼š

  <img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221204232534455.png" alt="image-20221204232534455" style="zoom:50%;" />

  > å¯ä»¥å¤šå°å®¢æˆ·ç«¯åŒæ—¶æ¥å…¥ï¼Œé€€å‡ºå»ä¹‹åä¹Ÿå¯ä»¥å†è¿›æ¥

### ä»£ç ï¼š

https://github.com/rachhhhing/mp2022_python/blob/master/week13

### Ref:

- UDPé€šä¿¡ï¼šhttps://blog.csdn.net/qq_19446965/article/details/110678592
- opencvï¼šhttps://zhuanlan.zhihu.com/p/44255577

**æœ€åï¼Œæœ¬å‘¨ä½œä¸šç‰¹åˆ«é¸£è°¢ ljx å’Œ jzk åŒå­¦ï¼Œåœ¨ä¸€èµ·åˆ†è£…ç‰©èµ„çš„æ™šä¸Šä¸“é—¨å¸¦ç”µè„‘å‡ºé—¨å¸®æˆ‘æµ‹è¯•**

**ç‰¹åˆ«æ‰¹è¯„ dxl åŒå­¦ï¼Œæ˜æ˜ä¹Ÿè¦æ¥å´ä»¥ç”µè„‘å¤ªé‡ä¸ºç”±æ‹’ç»äº†æˆ‘ğŸ˜¡**
