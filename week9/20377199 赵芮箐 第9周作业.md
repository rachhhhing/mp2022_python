# 20377199 赵芮箐 第9周作业

![image-20221031144328247](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221031144328247.png)

### 任务一：实现random_walk生成器，并利用zip，生成一组时间上对齐的多维随机游走序列

```python
# 实现random_walk生成器
def random_walk(mu, x, sigma_square, N):
    for i in range(N):
        yield x
        w_t = np.random.normal(0,math.sqrt(sigma_square))
        x = mu + x + w_t

# 测试
for i in random_walk(1, 1, 4, 10):
    print(i)

# 实现多维随机游走序列生成器，PS:这里以三维为例
def random_walk_vector(mu, x, s1, s2, s3, N):
    vector = []
    walk1 = list(random_walk(mu, x, s1, N))
    walk2 = list(random_walk(mu, x, s2, N))
    walk3 = list(random_walk(mu, x, s3, N))
    for vec in zip(walk1, walk2, walk3):
        vector.append(vec)
    return vector

# 测试
vector = random_walk_vector(1, 1, 0.01, 25, 100, 10)
for vec in vector:
    print(vec)
```

**结果展示：**

- random_walk 生成器

  <img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221031172318170.png" alt="image-20221031172318170" style="zoom:80%;" />

- 时间上对齐的多维随机游走序列

  <img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221031172331764.png" alt="image-20221031172331764" style="zoom:80%;" />

  > 看的出σ越大，序列在该维度游走的越不稳定，更随机

### 任务二：设计FaceDataset类，实现图片数据的加载

```python
# 设计FaceDataset类，实现图片数据的加载
class FaceDataset():
    def __init__(self, index=0, max=sys.maxsize):
        self._pathlist = []
        self._index = index							# 从第几张开始加载
        self._max = max                        		# 最多加载多少张
    
    def load_path(self, path_dir):
        print("-----开始加载图片路径-----")
        for root, dirs, files in os.walk(path_dir):	# 生成器，遍历目录
            for name in files:
                self._pathlist.append(os.path.join(root, name))
        print(f"-----图片路径加载完成，共{len(self._pathlist)}张图片-----")
        if self._max > len(self._pathlist):
            self._max = len(self._pathlist)
        self._path = self._pathlist[0]

    def process(self):
        # 当遇到数据截断的图片，PIL不报错，进行下一个
        ImageFile.LOAD_TRUNCATED_IMAGES = True
        image = Image.open(self._path)
        image_array = np.array(image)
        return image_array
    
    def __iter__(self):
        return self

    def __next__(self):
        if self._index+1 <= self._max:
            self._path = self._pathlist[self._index]
            self._index += 1
            return self.process()
        else:
            raise StopIteration('{}张图片已处理完毕'.format(self._max))

# 测试
@ profile()
def normal_process():
    path_dir = 'week9/originalPics'
    ImageFile.LOAD_TRUNCATED_IMAGES = True
    for root, dirs, files in os.walk(path_dir):
            for name in files:
                path = os.path.join(root, name)
                image = Image.open(path)
                image_array = np.array(image)
                print(image_array)

@ profile()
def iterable_process():
    path_dir = 'week9/originalPics'
    face = FaceDataset()
    face.load_path(path_dir)
    for img in face:
        print(img)
        #pass

#normal_process()
iterable_process()
```

**结果展示：**

不批量处理：

- ![image-20221103143926712](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221103143926712.png)

  > 运行CPU占用一直维持在30%-40%左右，内存占用一直维持在750MB左右

  ![image-20221103144755616](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221103144755616.png)

- 利用FaceDataset处理：

  ![image-20221103114053380](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221103114053380.png)

  > 运行CPU占用一直维持在40%-50%左右，内存占用一直维持在600MB左右

  ![image-20221103142445209](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221103142445209.png)

用profile()观察发现，如果处理全部数据的话，迭代器其实反而没啥优势啊，直接用for循环处理还内存少点。

于是去了解了一下Dataset 和 DataLoader：

- https://blog.csdn.net/weixin_45901519/article/details/115672355

- https://blog.csdn.net/jx69693678nab/article/details/103819766

![image-20221103160008474](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20221103160008474.png)

就好处就是说，因为在深度学习的时候，全部的数据集可能会很大，但我们是拿训练集进行训练，所以，每次批量加载就好了。规定好batch_size，利用迭代器，就可以实现小批量循环迭代式的读取，就避免了耗时太长或者内存有限的问题（所以上面处理全部数据+只是print看不出来个啥）

### 代码：

https://github.com/rachhhhing/mp2022_python/blob/master/week9/week9.py

### Ref：

- 图片的ndarray形式：https://blog.csdn.net/yideqianfenzhiyi/article/details/79193657
- os.walk：https://www.runoob.com/python/os-walk.html

